"""
–ú–æ–¥—É–ª—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∞–ª–µ—Ä—Ç–æ–≤ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö.
–°–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ –∞–ª–µ—Ä—Ç–æ–≤ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
"""
import re
import os
from langchain.tools import Tool
from datetime import datetime, timedelta
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∞–ª–µ—Ä—Ç–æ–≤ –∏–∑ –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è
from src.alert_processing.alert_parser import (
    parse_alert,
    get_data_alert as parse_get_data_alert,
    extract_additional_alert_info,
    get_icon_for_key,
    extract_service_name
)
from .logging_utils import tool_logger

# –§—É–Ω–∫—Ü–∏—è-–∑–∞–≥–ª—É—à–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∏–º–ø–æ—Ä—Ç get_bot_response –Ω–µ —É–¥–∞—Å—Ç—Å—è
def fallback_bot_response(prompt, max_tokens=1000, alert_data=None):
    """
    –†–µ–∑–µ—Ä–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞, –∫–æ–≥–¥–∞ –æ—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.
    
    Args:
        prompt: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞
        max_tokens: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤
        alert_data: –î–∞–Ω–Ω—ã–µ –∞–ª–µ—Ä—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
    Returns:
        str: –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    """
    import traceback
    error_info = traceback.format_exc()
    tool_logger.error(f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–≥–ª—É—à–∫–∏ fallback_bot_response. –ó–∞–ø—Ä–æ—Å: {prompt[:50]}...")
    tool_logger.error(f"–°—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤:\n{error_info}")
    
    return f"""–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∏–∑-–∑–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ get_bot_response
2. –í–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –æ—Ç–≤–µ—Ç
3. –í–æ–∑–º–æ–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API GigaChat –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–º–ø–æ—Ä—Ç–∞

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–æ–±—â–∏—Ç–µ –æ–± —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º.
"""

# –§—É–Ω–∫—Ü–∏—è get_data_alert —Ç–µ–ø–µ—Ä—å —è–≤–ª—è–µ—Ç—Å—è –æ–±–µ—Ä—Ç–∫–æ–π –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ alert_parser
def get_data_alert(alert_text: str) -> dict:
    """
    –ü–æ–ª—É—á–∏–≤ —Ç–µ–∫—Å—Ç –∞–ª–µ—Ä—Ç–∞, —Ä–∞–∑–±–∏—Ä–∞–µ—Ç –µ–≥–æ –Ω–∞ —á–∞—Å—Ç–∏, —Å–æ–æ–±—â–∞–µ—Ç –∫–æ–≥–¥–∞ –±—ã–ª –∞–ª–µ—Ä—Ç,
    –Ω–∞ –∫–∞–∫–æ–º —Å–µ—Ä–≤–∏—Å–µ, –∫–∞–∫–∞—è –æ—à–∏–±–∫–∞ –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –∫–æ–¥ HTTP –æ—à–∏–±–∫–∏,
    —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∫–∞–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö OpenShift –≤–æ–∑–Ω–∏–∫–ª–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∏ —É–∫–∞–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–∏–æ–¥,
    –∑–∞ –∫–æ—Ç–æ—Ä—ã–π —Å–ª–µ–¥—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏.
    
    Args:
        alert_text: –¢–µ–∫—Å—Ç –∞–ª–µ—Ä—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        
    Returns:
        dict: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–ª–µ—Ä—Ç–∞
    """
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –º–æ–¥—É–ª—è alert_parser
    return parse_get_data_alert(alert_text)

def analyze_file_alert(file_path: str = None, alert_number: int = None) -> str:
    """
    –ê–Ω–∞–ª–∏–∑ –∞–ª–µ—Ä—Ç–∞ –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–ª–∏ —Ñ–∞–π–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
    –ß–∏—Ç–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –µ–≥–æ.
    
    Args:
        file_path: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å –∞–ª–µ—Ä—Ç–æ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        alert_number: –ù–æ–º–µ—Ä –∞–ª–µ—Ä—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤ —Ñ–∞–π–ª–µ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∞–ª–µ—Ä—Ç–∞–º–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
    Returns:
        str: –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –∞–ª–µ—Ä—Ç–∞
    """
    try:
        tool_logger.info(f"–í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ analyze_file_alert c –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: file_path={file_path}, alert_number={alert_number}")
        
        # –ï—Å–ª–∏ –ø—É—Ç—å –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–π–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if not file_path:
            # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É –∞–ª–µ—Ä—Ç–∞
            try:
                from src.config.settings import get_alert_file_path
                file_path = get_alert_file_path()
                tool_logger.info(f"–ü–æ–ª—É—á–µ–Ω –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∞–ª–µ—Ä—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {file_path}")
            except ImportError:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –ø—É—Ç—å
                root_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), "..", ".."))
                test_alerts_dir = os.path.join(root_dir, 'tests', 'fixtures')
                
                # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ª—é–±–æ–π .txt —Ñ–∞–π–ª –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –∞–ª–µ—Ä—Ç–∞–º–∏
                try:
                    for filename in os.listdir(test_alerts_dir):
                        if filename.endswith('.txt'):
                            file_path = os.path.join(test_alerts_dir, filename)
                            tool_logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –∞–ª–µ—Ä—Ç–∞: {file_path}")
                            break
                    else:
                        default_file = os.path.join(test_alerts_dir, 'multiple_alerts.txt')
                        tool_logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã –∞–ª–µ—Ä—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {default_file}")
                        file_path = default_file
                except Exception as e:
                    tool_logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ñ–∞–π–ª–æ–≤ –∞–ª–µ—Ä—Ç–æ–≤: {str(e)}")
                    default_file = os.path.join(test_alerts_dir, 'multiple_alerts.txt')
                    file_path = default_file
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        if not os.path.exists(file_path):
            error_msg = f"–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}"
            tool_logger.error(error_msg)
            return error_msg
        
        # –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
        tool_logger.info(f"–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞: {file_path}")
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                alert_text = f.read()
        except UnicodeDecodeError:
            # –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –≤ UTF-8, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –∫–æ–¥–∏—Ä–æ–≤–∫—É
            with open(file_path, 'r', encoding='cp1251') as f:
                alert_text = f.read()
        
        tool_logger.info(f"–ü—Ä–æ—á–∏—Ç–∞–Ω–æ {len(alert_text)} —Å–∏–º–≤–æ–ª–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞")
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∞–ª–µ—Ä—Ç–æ–≤
        # –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –ü–†–û–ú, PROM –∏–ª–∏ DEV, –∑–∞—Ç–µ–º |
        alert_starts = re.finditer(r'(?:^|\n)(?:–ü–†–û–ú|PROM|DEV) \|', alert_text)
        alert_positions = [match.start() for match in alert_starts]
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∞–ª–µ—Ä—Ç–∞ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        if not alert_positions:
            # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω - –∏—â–µ–º —Å—Ç—Ä–æ–∫–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å "–ê–° –†–µ—Ñ–ª–µ–∫—Å"
            alt_alert_starts = re.finditer(r'(?:^|\n)–ê–° –†–µ—Ñ–ª–µ–∫—Å', alert_text)
            alert_positions = [match.start() for match in alt_alert_starts]
            
            # –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π, –ø—Ä–æ—Å—Ç–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∫–∞–∫ –æ–¥–∏–Ω –∞–ª–µ—Ä—Ç
            if not alert_positions:
                tool_logger.info("–ù–µ –Ω–∞–π–¥–µ–Ω—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∞–ª–µ—Ä—Ç–æ–≤, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∫–∞–∫ –æ–¥–∏–Ω –∞–ª–µ—Ä—Ç")
                return analyze_single_alert(alert_text, include_bot_analysis=True)
        
        # –†–∞–∑–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã
        alerts = []
        for i in range(len(alert_positions)):
            start = alert_positions[i]
            # –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–ª–µ—Ä—Ç, –±–µ—Ä–µ–º —Ç–µ–∫—Å—Ç –¥–æ –∫–æ–Ω—Ü–∞ —Ñ–∞–π–ª–∞
            end = alert_positions[i+1] if i < len(alert_positions) - 1 else len(alert_text)
            alert_content = alert_text[start:end].strip()
            alerts.append(alert_content)
        
        tool_logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(alerts)} –∞–ª–µ—Ä—Ç–æ–≤ –≤ —Ñ–∞–π–ª–µ")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞–ª–µ—Ä—Ç
        if alert_number is not None:
            tool_logger.info(f"–ó–∞–ø—Ä–æ—à–µ–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞–ª–µ—Ä—Ç —Å –Ω–æ–º–µ—Ä–æ–º {alert_number}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π –∞–ª–µ—Ä—Ç
            if alert_number <= 0 or alert_number > len(alerts):
                error_msg = f"–í —Ñ–∞–π–ª–µ —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è {len(alerts)} –∞–ª–µ—Ä—Ç–æ–≤. –ù–µ—Ç –∞–ª–µ—Ä—Ç–∞ —Å –Ω–æ–º–µ—Ä–æ–º {alert_number}."
                tool_logger.error(error_msg)
                return error_msg
                
            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π –∞–ª–µ—Ä—Ç
            specific_alert = alerts[alert_number - 1]
            result = f"## –ê–ª–µ—Ä—Ç #{alert_number}\n\n"
            analysis = analyze_single_alert(specific_alert, include_bot_analysis=True)
            result += analysis
            
            tool_logger.info(f"–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∞–ª–µ—Ä—Ç #{alert_number}")
            return result
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –∞–ª–µ—Ä—Ç –æ—Ç–¥–µ–ª—å–Ω–æ
        results = []
        open_count = 0
        resolved_count = 0
        unknown_count = 0
        
        for i, alert in enumerate(alerts, 1):
            try:
                # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç–∞—Ç—É—Å –∞–ª–µ—Ä—Ç–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞
                status_match = re.search(r'(?:OPEN|RESOLVED|ACTIVE)', alert, re.IGNORECASE)
                status = status_match.group().upper() if status_match else "UNKNOWN"
                
                if status == "OPEN" or status == "ACTIVE":
                    open_count += 1
                elif status == "RESOLVED":
                    resolved_count += 1
                else:
                    unknown_count += 1
                
                # –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–ª–µ—Ä—Ç–∞ –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                result = f"### –ê–ª–µ—Ä—Ç {i}: {status}\n\n"
                analysis = analyze_single_alert(alert, include_bot_analysis=False)
                result += analysis
                results.append(result)
                
            except Exception as e:
                error_msg = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∞–ª–µ—Ä—Ç–∞ {i}: {str(e)}"
                tool_logger.error(error_msg, exc_info=True)
                results.append(f"### –ê–ª–µ—Ä—Ç {i}: –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞\n\n‚ö†Ô∏è {error_msg}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—â—É—é —Å–≤–æ–¥–∫—É –ø–æ –∞–ª–µ—Ä—Ç–∞–º
        summary = f"# üìä –°–≤–æ–¥–∫–∞ –ø–æ –∞–ª–µ—Ä—Ç–∞–º\n\n"
        summary += f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∞–ª–µ—Ä—Ç–æ–≤: **{len(alerts)}**\n\n"
        
        if open_count > 0:
            summary += f"‚ö†Ô∏è **–í–Ω–∏–º–∞–Ω–∏–µ:** {open_count} –∞–ª–µ—Ä—Ç–æ–≤ —Ç—Ä–µ–±—É—é—Ç –≤–∞—à–µ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è.\n\n"
            
        if resolved_count > 0:
            summary += f"‚úÖ **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:** {resolved_count} –∞–ª–µ—Ä—Ç–æ–≤ —É–∂–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç –¥–µ–π—Å—Ç–≤–∏–π.\n\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∞–ª–µ—Ä—Ç–æ–≤
        summary += add_general_recommendations(open_count, resolved_count, unknown_count)
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        combined_result = f"{summary}\n## –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∞–ª–µ—Ä—Ç–æ–≤\n\n" + "\n\n".join(results)
        
        tool_logger.info(f"–£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω –∞–Ω–∞–ª–∏–∑ {len(alerts)} –∞–ª–µ—Ä—Ç–æ–≤")
        
        return combined_result
            
    except Exception as e:
        error_message = f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞: {str(e)}"
        tool_logger.error(error_message, exc_info=True)
        return f"‚ö†Ô∏è **–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞:** {str(e)}"

def add_general_recommendations(open_count, resolved_count, unknown_count):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –æ–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∞–ª–µ—Ä—Ç–æ–≤
    
    Args:
        open_count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤
        resolved_count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—à–µ–Ω–Ω—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤
        unknown_count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–ª–µ—Ä—Ç–æ–≤ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º
        
    Returns:
        str: –°—Ç—Ä–æ–∫–∞ —Å –æ–±—â–∏–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
    """
    recommendations = "## üìã –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n\n"
    
    if open_count > 0:
        recommendations += "### üî¥ –ü–æ –∞–∫—Ç–∏–≤–Ω—ã–º –∞–ª–µ—Ä—Ç–∞–º\n\n"
        recommendations += "1. **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è:** –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∞–ª–µ—Ä—Ç—ã —Å –≤—ã—Å–æ–∫–∏–º —É—Ä–æ–≤–Ω–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (ERROR, AVAILABILITY)\n"
        recommendations += "2. **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –º–æ–≥—É—Ç –ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–ª–µ—Ä—Ç–æ–≤ –±—ã—Ç—å —Å–≤—è–∑–∞–Ω—ã —Å –æ–¥–Ω–æ–π –ø–µ—Ä–≤–æ–ø—Ä–∏—á–∏–Ω–æ–π\n"
        recommendations += "3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—Å–ª–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã\n\n"
    
    if resolved_count > 0:
        recommendations += "### üü¢ –ü–æ —Ä–µ—à–µ–Ω–Ω—ã–º –∞–ª–µ—Ä—Ç–∞–º\n\n"
        recommendations += "1. **–ê–Ω–∞–ª–∏–∑:** –ò–∑—É—á–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é —Ä–µ—à–µ–Ω–Ω—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –ø—Ä–æ–±–ª–µ–º\n"
        recommendations += "2. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ó–∞–ø–∏—à–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏–Ω—è—Ç—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º\n"
        recommendations += "3. **–ü—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω—ã–µ –º–µ—Ä—ã:** –†–∞–∑—Ä–∞–±–æ—Ç–∞–π—Ç–µ –º–µ—Ä—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º\n\n"
    
    if unknown_count > 0:
        recommendations += "### ‚ö†Ô∏è –ü–æ –∞–ª–µ—Ä—Ç–∞–º —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º\n\n"
        recommendations += "1. **–£—Ç–æ—á–Ω–µ–Ω–∏–µ:** –£—Ç–æ—á–Ω–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –∞–ª–µ—Ä—Ç–æ–≤ –∏ –∏—Ö –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å\n"
        recommendations += "2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞\n\n"
    
    return recommendations

def analyze_single_alert(alert_text, include_bot_analysis=True):
    """
    –ê–Ω–∞–ª–∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∞–ª–µ—Ä—Ç–∞.
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –∞–ª–µ—Ä—Ç–∞ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥.
    
    Args:
        alert_text: –¢–µ–∫—Å—Ç –∞–ª–µ—Ä—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        include_bot_analysis: –í–∫–ª—é—á–∞—Ç—å –ª–∏ –∞–Ω–∞–ª–∏–∑ —Å –ø–æ–º–æ—â—å—é –±–æ—Ç–∞
        
    Returns:
        str: –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –∞–ª–µ—Ä—Ç–∞
    """
    tool_logger.info("–ê–Ω–∞–ª–∏–∑ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –∞–ª–µ—Ä—Ç–∞")
    
    try:
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∞–ª–µ—Ä—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ alert_parser
        http_code_match = re.search(r'HTTP (?:ERROR )?(\d{3})|(\d{3}) POST', alert_text, re.IGNORECASE)
        http_code = http_code_match.group(1) if http_code_match and http_code_match.group(1) else http_code_match.group(2) if http_code_match else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–µ—Ç–∞–ª–∏ –æ —Å–µ—Ä–≤–∏—Å–µ –∏ —Ç–∏–ø–µ –∞–ª–µ—Ä—Ç–∞
        service = extract_service_name(alert_text)
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–∏–ø –∞–ª–µ—Ä—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ–Ω –≤ —Å–µ–±–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞—Ç—É—Å–µ
        alert_type_match = re.search(r'\| ([^|]+) \|', alert_text)
        alert_type = alert_type_match.group(1).strip() if alert_type_match else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø"
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ –∞–ª–µ—Ä—Ç–∞ - —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
        timestamp_match = re.search(r'(\d{2}\.\d{2}\.\d{4} \d{2}:\d{2}:\d{2})', alert_text)
        if not timestamp_match:
            timestamp_match = re.search(r'(\d{2}:\d{2} \(\w+\) \d{2}\.\d{2}\.\d{4})', alert_text)
        
        timestamp = timestamp_match.group(1) if timestamp_match else "–í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ HTTP –æ—à–∏–±–∫–µ
        if http_code != "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ":
            has_http_error = True
        else:
            has_http_error = False
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–µ –∏–∑ –∞–ª–µ—Ä—Ç–∞
        request_match = re.search(r'Request:\s*([^\n]+)', alert_text)
        request = request_match.group(1).strip() if request_match else "–ù–µ —É–∫–∞–∑–∞–Ω"
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –∞–ª–µ—Ä—Ç–∞
        alert_id_match = re.search(r'P-(\d+)', alert_text)
        alert_id = alert_id_match.group(0) if alert_id_match else "–ù–µ —É–∫–∞–∑–∞–Ω"
        
        # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥
        structured_data = {
            "id": alert_id,
            "service": service,
            "http_code": http_code,
            "timestamp": timestamp,
            "alert_type": alert_type,
            "request": request,
            "has_http_error": has_http_error
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ alert_parser, –µ—Å–ª–∏ –æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
        try:
            additional_info = extract_additional_alert_info(alert_text)
            for key, value in additional_info.items():
                if key not in structured_data or not structured_data[key]:
                    structured_data[key] = value
        except Exception as e:
            tool_logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é: {str(e)}")
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        result = f"#### üìù –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\n\n"
        result += f"- **ID –∞–ª–µ—Ä—Ç–∞:** {structured_data['id']}\n"
        result += f"- **–°–µ—Ä–≤–∏—Å:** {structured_data['service'] or '–ù–µ —É–∫–∞–∑–∞–Ω'}\n"
        result += f"- **–¢–∏–ø –∞–ª–µ—Ä—Ç–∞:** {structured_data['alert_type']}\n"
        result += f"- **–í—Ä–µ–º—è:** {structured_data['timestamp']}\n"
        
        if has_http_error:
            result += f"- **HTTP –∫–æ–¥:** {structured_data['http_code']}\n"
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É HTTP –∫–æ–¥–∞
            if structured_data['http_code'].startswith('4'):
                result += f"  - **–û–ø–∏—Å–∞–Ω–∏–µ:** –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –æ—à–∏–±–∫–∞ (–ø—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–ø—Ä–æ—Å–æ–º)\n"
            elif structured_data['http_code'].startswith('5'):
                result += f"  - **–û–ø–∏—Å–∞–Ω–∏–µ:** –°–µ—Ä–≤–µ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞ (–ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞)\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–µ, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
        if request != "–ù–µ —É–∫–∞–∑–∞–Ω":
            result += f"- **–ó–∞–ø—Ä–æ—Å:** `{request}`\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        result += "\n#### üìä –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\n\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –ø–æ–ª–µ–π –∞–ª–µ—Ä—Ç–∞
        for key, value in structured_data.items():
            if key not in ["id", "service", "http_code", "timestamp", "alert_type", "request", "has_http_error"] and value:
                icon = get_icon_for_key(key)
                result += f"- **{icon} {key.capitalize()}:** {value}\n"
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º HTTP –æ—à–∏–±–∫—É –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ
        if has_http_error:
            result += "\n#### üîç –ê–Ω–∞–ª–∏–∑ HTTP –æ—à–∏–±–∫–∏\n\n"
            if structured_data['http_code'].startswith('4'):
                result += "- –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–ø—Ä–æ—Å–æ–º:\n"
                result += "  - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞\n"
                result += "  - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é\n"
                result += "  - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–π —Ä–µ—Å—É—Ä—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\n"
            elif structured_data['http_code'].startswith('5'):
                result += "- –°–µ—Ä–≤–µ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä–≤–∏—Å–æ–º:\n"
                result += "  - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫\n"
                result += "  - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π\n"
                result += "  - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ—Å—É—Ä—Å—ã —Å–µ—Ä–≤–µ—Ä–∞ (CPU, –ø–∞–º—è—Ç—å, –¥–∏—Å–∫)\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º
        result += "\n#### üõ† –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è\n\n"
        
        if structured_data.get("status", "").upper() == "RESOLVED":
            result += "‚úÖ **–ê–ª–µ—Ä—Ç —É–∂–µ —Ä–∞–∑—Ä–µ—à–µ–Ω.** –î–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏–∑—É—á–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è.\n"
        else:
            # –ï—Å–ª–∏ –µ—Å—Ç—å HTTP –æ—à–∏–±–∫–∞, –¥–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –µ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é
            if has_http_error:
                if structured_data['http_code'].startswith('4'):
                    result += "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã\n"
                    result += "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞\n"
                elif structured_data['http_code'].startswith('5'):
                    result += "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥\n"
                    result += "2. –ò–∑—É—á–∏—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—à–∏–±–æ–∫\n"
            
            # –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∞–ª–µ—Ä—Ç–æ–≤
            result += "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏–º—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤\n"
            result += "4. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤ Kubernetes, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:\n"
            result += f"- –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏: `kubectl logs <pod-name>`\n"
            result += f"- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–±—ã—Ç–∏—è: `kubectl get events`\n\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –∞–ª–µ—Ä—Ç–∞
        if structured_data.get("alert_type"):
            if "AVAILABILITY" in structured_data["alert_type"]:
                result += f"**üìä –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:**\n\n"
                result += f"- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞\n"
                result += f"- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\n"
                result += f"- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –Ω–∏–∂–µ 99.9%\n\n"
            elif "ERROR" in structured_data["alert_type"]:
                result += f"**‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –æ—à–∏–±–∫–∞–º–∏:**\n\n"
                result += f"- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —á–∞—Å—Ç—ã—Ö –æ—à–∏–±–æ–∫\n"
                result += f"- –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –≤ –µ–¥–∏–Ω–∏—Ü—É –≤—Ä–µ–º–µ–Ω–∏\n"
                result += f"- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã—Ö –æ—à–∏–±–æ–∫ –¥–ª—è –æ–±–ª–µ–≥—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞\n\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∞–ª–∏–∑ –æ—Ç –±–æ—Ç–∞, –µ—Å–ª–∏ —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è
        if include_bot_analysis:
            try:
                from src.core.agent import get_bot_response
                result += "\n#### ü§ñ –ê–Ω–∞–ª–∏–∑ –æ—Ç AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞\n\n"
                bot_prompt = f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π –∞–ª–µ—Ä—Ç –∏ –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º—É, –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é:\n\n{alert_text}"
                bot_response = get_bot_response(bot_prompt, max_tokens=800, alert_data=structured_data)
                result += bot_response
            except ImportError:
                tool_logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å get_bot_response, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É")
                bot_response = fallback_bot_response(alert_text, alert_data=structured_data)
                result += bot_response
        
        return result
        
    except Exception as e:
        error_message = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∞–ª–µ—Ä—Ç–∞: {str(e)}"
        tool_logger.error(error_message, exc_info=True)
        return f"‚ö†Ô∏è **–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:** {str(e)}"

def get_related_alert_info(alert_data):
    """
    –ü–æ–ª—É—á–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∞–ª–µ—Ä—Ç—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ –¥–∞–Ω–Ω—ã—Ö.
    
    Args:
        alert_data: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∞–ª–µ—Ä—Ç–∞
        
    Returns:
        str: –°—Ç—Ä–æ–∫–∞ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    """
    result = ""
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ HTTP –∫–æ–¥–∞—Ö, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω HTTP –∫–æ–¥
    if alert_data.get('http_code') and alert_data['http_code'] not in ["–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ", None]:
        http_code = str(alert_data['http_code'])
        
        http_code_descriptions = {
            "4xx": "–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –æ–±—ã—á–Ω–æ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–ø—Ä–æ—Å–æ–º –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞. "
                  "–í–æ–∑–º–æ–∂–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏–ª–∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.",
            "5xx": "–°–µ—Ä–≤–µ—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–µ—Ä–≤–µ—Ä–∞. "
                  "–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞, —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ä–µ—Å—É—Ä—Å–æ–≤."
        }
        
        if http_code.startswith("4"):
            result += f"**üîç –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –æ—à–∏–±–∫–µ (4xx):**\n\n"
            result += f"{http_code_descriptions['4xx']}\n\n"
        elif http_code.startswith("5"):
            result += f"**üîç –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –æ—à–∏–±–∫–µ (5xx):**\n\n"
            result += f"{http_code_descriptions['5xx']}\n\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö HTTP –∫–æ–¥–æ–≤
        specific_recommendations = {
            "400": "–ù–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–ø—Ä–æ—Å–∞.",
            "401": "–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.",
            "403": "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.",
            "404": "–†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –∏–ª–∏ –º–∞—Ä—à—Ä—É—Ç—ã API.",
            "408": "–¢–∞–π–º-–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞. –£–≤–µ–ª–∏—á—å—Ç–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞.",
            "500": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.",
            "502": "–ü–ª–æ—Ö–æ–π —à–ª—é–∑. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏.",
            "503": "–°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –∏ –µ–≥–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.",
            "504": "–¢–∞–π–º-–∞—É—Ç —à–ª—é–∑–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ."
        }
        
        if http_code in specific_recommendations:
            result += f"**üìå –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è HTTP {http_code}:**\n\n"
            result += f"{specific_recommendations[http_code]}\n\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ Kubernetes, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å K8s
    if alert_data.get('service') and ('pod' in alert_data['service'].lower() or 'k8s' in alert_data['service'].lower() or 'kubernetes' in alert_data['service'].lower()):
        result += f"**‚ò∏Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ Kubernetes:**\n\n"
        result += f"- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–∞: `kubectl describe pod <pod-name> -n <namespace>`\n"
        result += f"- –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏: `kubectl logs <pod-name>`\n"
        result += f"- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–±—ã—Ç–∏—è: `kubectl get events`\n\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –∞–ª–µ—Ä—Ç–∞
    if alert_data.get("alert_type"):
        if "AVAILABILITY" in alert_data["alert_type"]:
            result += f"**üìä –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:**\n\n"
            result += f"- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞\n"
            result += f"- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\n"
            result += f"- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –Ω–∏–∂–µ 99.9%\n\n"
        elif "ERROR" in alert_data["alert_type"]:
            result += f"**‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –æ—à–∏–±–∫–∞–º–∏:**\n\n"
            result += f"- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —á–∞—Å—Ç—ã—Ö –æ—à–∏–±–æ–∫\n"
            result += f"- –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –≤ –µ–¥–∏–Ω–∏—Ü—É –≤—Ä–µ–º–µ–Ω–∏\n"
            result += f"- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã—Ö –æ—à–∏–±–æ–∫ –¥–ª—è –æ–±–ª–µ–≥—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞\n\n"
    
    return result

# –°–æ–∑–¥–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ get_data_alert
get_data_alert_tool = Tool(
    name="Data Alert Parser",
    func=get_data_alert,
    description="–ü–æ–ª—É—á–∞—é —Ç–µ–∫—Å—Ç –∞–ª–µ—Ä—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é —Ä–∞–∑–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö."
)

# –°–æ–∑–¥–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∞–ª–µ—Ä—Ç–∞ –∏–∑ —Ñ–∞–π–ª–∞
analyze_file_alert_tool = Tool(
    name="File Alert Analyzer",
    func=analyze_file_alert,
    description="–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∞–ª–µ—Ä—Ç –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞."
)

# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏
get_data_alert = get_data_alert_tool
analyze_file_alert_tool = analyze_file_alert_tool  # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ invoke
analyze_file_alert = analyze_file_alert  # –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞ 